<!doctype html><html lang="en"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>CurbEase Admin â€” Referrals</title>
<style>
body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:20px;color:#111827}
table{border-collapse:collapse;width:100%} th,td{border:1px solid #e5e7eb;padding:8px} th{background:#f3f4f6;text-align:left}
input,select,button{padding:8px;border:1px solid #e5e7eb;border-radius:8px}
.actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:10px}
.badge{display:inline-block;padding:4px 8px;border-radius:999px;background:#eef6ff;color:#1d4ed8;font-size:12px}
</style>
<script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
</head><body>

<div id="auth-guard" style="display:none; position:fixed; inset:0; background:#111827; color:#fff; display:grid; place-items:center; z-index:99999;">
  <div style="text-align:center; max-width:420px; padding:20px;">
    <h2 style="margin:0 0 8px">Admin Login Required</h2>
    <p style="margin:0 0 16px; opacity:0.9;">Please sign in with Netlify Identity. Your account must have the <strong>admin</strong> role.</p>
    <button onclick="netlifyIdentity.open('login')" style="background:#22c55e;color:#052e12;padding:10px 14px;border:none;border-radius:10px;font-weight:800;cursor:pointer">Sign In</button>
  </div>
</div>

<h1>Referrals Admin</h1>
<p class="badge">Beta</p>
<p>Publish your Google Sheet and set the CSV URL + Update Endpoint in <code>assets/js/admin-config.js</code>. Use the controls below to mark credits as applied.</p>

<div class="actions">
  <button onclick="reloadSheet()">Reload Sheet</button>
  <label>Filter by Plan:
    <select id="filter-plan">
      <option value="">All</option>
      <option>basic</option>
      <option>standard</option>
      <option>premium</option>
    </select>
  </label>
  <label>Search email: <input id="search-email" placeholder="user@example.com"></label>
</div>

<div id="table-wrap" style="margin-top:14px; overflow:auto;"></div>

<h2>Mark Credit Applied</h2>
<div class="actions">
  <input id="target-email" placeholder="Referrer email">
  <select id="plan-select">
    <option>basic</option><option>standard</option><option>premium</option>
  </select>
  <button onclick="markCredit()">Mark 1 Week Credit Applied</button>
  <span id="status" style="margin-left:8px;color:#16a34a"></span>
</div>

<script src="/assets/js/admin-config.js"></script>
<script>

async function fetchReferralsFunction(){
  const user = netlifyIdentity.currentUser();
  if(!user){ throw new Error('Not logged in'); }
  const token = await user.jwt();
  const res = await fetch('/.netlify/functions/list-referrals', {
    headers: { Authorization: 'Bearer ' + token }
  });
  if(!res.ok){ throw new Error('Failed to fetch referrals'); }
  return (await res.json()).rows || [];
}


function renderTableFromObjects(rows){
  if(!rows || !rows.length){ document.getElementById('table-wrap').innerHTML='No data'; return; }
  const headers = ['timestamp','customer_email','plan','referrer_name','referrer_email','referral_code','id'];
  const planFilter = (document.getElementById('filter-plan')||{}).value || '';
  const emailQuery = (document.getElementById('search-email')||{}).value || '';
  const filtered = rows.filter(r => {
    const matchesPlan = !planFilter || (r.plan||'').toLowerCase() === planFilter;
    const matchesEmail = !emailQuery || (r.customer_email||'').toLowerCase().includes(emailQuery.toLowerCase()) || (r.referrer_email||'').toLowerCase().includes(emailQuery.toLowerCase());
    return matchesPlan && matchesEmail;
  });
  let html = '<table><thead><tr>' + headers.map(h=>'<th>'+h.replace('_',' ').toUpperCase()+'</th>').join('') + '</tr></thead><tbody>';
  for(const r of filtered){
    html += '<tr>' + headers.map((h)=>'<td>'+ (r[h]||'') +'</td>').join('') + '</tr>';
  }
  html += '</tbody></table>';
  document.getElementById('table-wrap').innerHTML = html;
}
  const [headers, ...data] = rows;
  const planFilter = (document.getElementById('filter-plan')||{}).value || '';
  const emailQuery = (document.getElementById('search-email')||{}).value || '';
  const idxPlan = headers.indexOf('Plan');
  const idxEmail = headers.indexOf('Customer Email');
  const filtered = data.filter(r => {
    if(!r.length) return false;
    const matchesPlan = !planFilter || (r[idxPlan]||'').toLowerCase() === planFilter;
    const matchesEmail = !emailQuery || (r[idxEmail]||'').toLowerCase().includes(emailQuery.toLowerCase());
    return matchesPlan && matchesEmail;
  });
  let html = '<table><thead><tr>' + headers.map(h=>'<th>'+h+'</th>').join('') + '</tr></thead><tbody>';
  for(const r of filtered){
    html += '<tr>' + headers.map((h,i)=>'<td>'+ (r[i]||'') +'</td>').join('') + '</tr>';
  }
  html += '</tbody></table>';
  document.getElementById('table-wrap').innerHTML = html;
}


async function reloadSheet(){

  try{
    document.getElementById('status').textContent = 'Loading...';
    const rows = await fetchReferralsFunction();
    window._REF_ROWS = rows;
    renderTableFromObjects(rows);
    document.getElementById('status').textContent = 'Loaded';
  }catch(e){
    document.getElementById('status').textContent = 'Failed to load CSV';
  }
}
document.getElementById('filter-plan').addEventListener('change', ()=>renderTable(window._REF_ROWS));
document.getElementById('search-email').addEventListener('input', ()=>renderTable(window._REF_ROWS));

async function markCredit(){
  const email = (document.getElementById('target-email')||{}).value || '';
  const plan = (document.getElementById('plan-select')||{}).value || '';
  if(!email){ document.getElementById('status').textContent = 'Enter referrer email'; return; }
  try{
    document.getElementById('status').textContent = 'Updating...';
    const res = await fetch('/.netlify/functions/mark-credit', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ referrer_email: email, plan: plan, credit_applied: true }) });
    if(!res.ok) throw new Error('Bad response');
    document.getElementById('status').textContent = 'Marked applied';
    setTimeout(()=>{ document.getElementById('status').textContent=''; }, 2000);
  }catch(e){
    document.getElementById('status').textContent = 'Update failed';
  }
}

reloadSheet();
</script>

<script>
(function(){
  const guard = document.getElementById('auth-guard');
  function showGuard(){ if(guard) guard.style.display = 'grid'; }
  function hideGuard(){ if(guard) guard.style.display = 'none'; }
  function hasAdminRole(user){
    const roles = (user && user.app_metadata && user.app_metadata.roles) || [];
    return roles.includes('admin');
  }
  netlifyIdentity.on('init', user => {
    if(!user || !hasAdminRole(user)){ showGuard(); }
    else { hideGuard(); reloadSheet(); }
  });
  netlifyIdentity.on('login', user => {
    if(!hasAdminRole(user)){ alert('Admin role required'); netlifyIdentity.logout(); showGuard(); return; }
    hideGuard(); reloadSheet();
  });
  netlifyIdentity.on('logout', () => { showGuard(); });
  netlifyIdentity.init();
})();
</script>

</body></html>