
<!doctype html>
<html lang="en">
<head>
<!-- GA4 base -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-E1XJNKX8B9"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-E1XJNKX8B9');
</script>

<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Thank you • CurbEase Bin Valet</title>
<style>
:root{--ink:#0f172a;--muted:#475569;--bg:#f6f9fc;--panel:#fff;--border:#e2e8f0}
*{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
.wrap{max-width:860px;margin:0 auto;padding:22px 16px}
.card{background:var(--panel);border:1px solid var(--border);border-radius:16px;box-shadow:0 8px 30px rgba(2,6,23,.06);padding:20px}
h1{margin:.2rem 0 1rem;font-size:2rem}
.lead{color:var(--muted);margin:0 0 1.2rem}
.kv{display:grid;grid-template-columns:160px 1fr;gap:10px;align-items:center;margin:.35rem 0}
.k{color:var(--muted)} .btn{display:inline-block;margin-top:14px;border:1px solid var(--border);border-radius:10px;background:#fff;padding:.65rem .9rem;text-decoration:none}
.badge{display:inline-block;margin-left:8px;background:rgba(22,163,74,.12);color:#065f46;border:1px solid rgba(16,185,129,.22);padding:.15rem .5rem;border-radius:999px;font-weight:700}
#err{color:#b91c1c;margin-top:8px;display:none}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1 id="greet">Thank you! <span id="badge" class="badge" style="display:none">Active</span></h1>
    <p class="lead">We’ve received your subscription. Your first set‑out reminder will arrive before your next pickup day.</p>
    <div class="kv"><div class="k">Name</div><div id="name">—</div></div>
    <div class="kv"><div class="k">Email</div><div id="email">—</div></div>
    <div class="kv"><div class="k">Plan</div><div id="plan">—</div></div>
    <div class="kv"><div class="k">Service address</div><div id="addr">—</div></div>
    <div class="kv"><div class="k">Bin location</div><div id="binloc">—</div></div>
    <a class="btn" href="https://billing.stripe.com/p/login/14AcMZ4gk1P10VK5yl9oc00">Go to your account</a>
    <a class="btn" href="/" style="margin-left:8px">Back to home</a>
    <div id="err"></div>
  </div>
</div>
<script>
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTAIuKTmyPU5OybJbNw9O7oWML19IHwU5Prnxy3_k3zMCjD3pYUUxBWFmJ31xMj_gOrzmh9OtdV_Kqe/pub?gid=319823546&single=true&output=csv";
const qs = new URLSearchParams(location.search);
const sessionId = qs.get('session_id') || qs.get('sessionId') || "";
function parseCSV(t){const r=[];let c=[''];let q=false;for(let i=0;i<t.length;i++){const a=t[i],n=t[i+1];if(q){if(a=='"'&&n=='"'){c[c.length-1]+='"';i++;}else if(a=='"'){q=false;}else c[c.length-1]+=a;}else{if(a=='"'){q=true;}else if(a==','){c.push('');}else if(a=='\n'){r.push(c);c=[''];}else if(a!='\r'){c[c.length-1]+=a;}}}r.push(c);return r.filter(x=>x.some(y=>y.trim()!==""));}
function pickIndex(h,n){const a=h.map(x=>x.trim().toLowerCase());for(const nm of n){const i=a.indexOf(nm);if(i>=0)return i}return -1}
async function fetchCSV(){try{const r=await fetch(CSV_URL,{cache:'no-store'});if(!r.ok)throw new Error('direct');return await r.text()}catch(e){const p='/.netlify/functions/fetch-csv?src='+encodeURIComponent(CSV_URL);const r=await fetch(p,{cache:'no-store'});return await r.text()}}
(async()=>{const err=document.getElementById('err');if(!sessionId){err.textContent='Missing session_id in URL.';err.style.display='block';return;}try{const txt=await fetchCSV();const rows=parseCSV(txt);const header=rows[0].map(h=>h.trim());const iSess=pickIndex(header,['session id','session_id','checkout_session_id','checkout session id']);const iName=pickIndex(header,['name','customer name']);const iEmail=pickIndex(header,['email','customer email']);const iPlan=pickIndex(header,['subscription','plan','price name']);const iAddr=pickIndex(header,['address','full address']);const iStreet=pickIndex(header,['street','address','street address','address line 1','address1','addr1']);const iUnit=pickIndex(header,['unit','apt','apartment','suite','address line 2','address2','addr2']);const iCity=pickIndex(header,['city']);const iState=pickIndex(header,['state','st','province']);const iZip=pickIndex(header,['zip','zipcode','postal code','postal']);const iBin=pickIndex(header,['bin location','bin_location']);const iStatus=pickIndex(header,['status']);const found=rows.slice(1).find(r=>(r[iSess]||'').trim()===sessionId);if(!found){err.textContent='Your subscription may take a moment to sync. Refresh shortly.';err.style.display='block';return;}const fullAddr=(()=>{const streetUnit=[found[iStreet],found[iUnit]].filter(Boolean).map(s=>String(s).trim()).join(' ');const cityState=[found[iCity],found[iState]].filter(Boolean).map(s=>String(s).trim()).join(', ');const combo=[streetUnit,cityState,found[iZip]?String(found[iZip]).trim():''].filter(Boolean).join(' ');return combo||(found[iAddr]||'—')})();const nm=(found[iName]||'there').toString().trim();const pl=(found[iPlan]||'your plan').toString().trim();document.getElementById('greet').firstChild.nodeValue=`Thanks ${nm}! You’re now subscribed to the ${pl} Plan. `;document.getElementById('name').textContent=found[iName]||'—';document.getElementById('email').textContent=found[iEmail]||'—';document.getElementById('plan').textContent=found[iPlan]||'—';document.getElementById('addr').textContent=fullAddr||'—';document.getElementById('binloc').textContent=found[iBin]||'—';if(found[iStatus]&&/^act/i.test(found[iStatus]))document.getElementById('badge').style.display='inline-block';}catch(e){err.textContent='Trouble loading your subscription. Please refresh.';err.style.display='block';}})();
</script>
<script>
(function(){
  function getParam(n){ try { return new URL(location.href).searchParams.get(n); } catch(e){ return null; } }
  const plan = (getParam('plan')||'').toLowerCase();
  const sid  = getParam('session_id') || getParam('cs') || getParam('session');
  if (plan && document.getElementById('plan')) {
    document.getElementById('plan').textContent = plan.charAt(0).toUpperCase()+plan.slice(1);
  }
  if (!sid) return;
  fetch('/.netlify/functions/get-checkout-session?id='+encodeURIComponent(sid), { cache:'no-store' })
    .then(r=>r.json()).then(d=>{
      const set=(id,v)=>{ const n=document.getElementById(id); if(n&&v) n.textContent=v; };
      set('name', d.name);
      set('email', d.email);
      set('address', [d.address,d.city,d.state,d.zip].filter(Boolean).join(', '));
      if (d.plan && document.getElementById('plan')) document.getElementById('plan').textContent = d.plan;
      if (document.getElementById('bin') && d.bin_location) document.getElementById('bin').textContent = d.bin_location;
      if (window.gtag){ gtag('event','signup_complete',{ value:1, currency:'USD', plan: (plan||d.plan||'unknown') }); }
    }).catch(console.warn);
})();
</script>

</body>
</html>